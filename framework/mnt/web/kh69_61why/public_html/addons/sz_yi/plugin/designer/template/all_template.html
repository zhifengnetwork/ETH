{template 'common/header'}<script language="javascript">require(['underscore']);</script> 
<!-- 导入CSS样式 -->
<link href="../addons/sz_yi/plugin/designer/template/imgsrc/designer.css" rel="stylesheet">
<!-- 头部选项卡 -->
<div class="ulleft-nav">
	<ul class="nav nav-tabs">
	    <li><a href="{php echo $this->createPluginWebUrl('designer')}" >店铺装修</a></li>
		<li><a href="{php echo $this->createPluginWebUrl('designer/menu')}" >自定义菜单</a></li> 
		<li><a href="{php echo $this->createPluginWebUrl('designer/style')}" >个人主页样式选择</a></li> 
		<li><a href="javascritp:;" >购物车样式选择</a></li>
		<li><a href="javascritp:;" >商品分类样式选择</a></li>
		<li class="active"><a href="{php echo $this->createPluginWebUrl('designer/all_template')}" >全部模版</a></li>
	</ul>
</div>

{if $op=='display'}
	<!-- 筛选区域 -->
	<div class="panel panel-info">
	    <div class="panel-heading">筛选</div>
	    <div class="panel-body">
	        <form action="./index.php" method="get" class="form-horizontal" role="form">
	            <input type="hidden" name="c" value="site" />
	            <input type="hidden" name="a" value="entry" />
	            <input type="hidden" name="m" value="sz_yi" />
	            <input type="hidden" name="do" value="plugin" />
	            <input type="hidden" name="p" value="designer" />
	            <div class="form-group">
	                <label class="col-xs-12 col-sm-2 col-md-2 col-lg-1 control-label">关键字</label>
	                <div class="col-sm-8 col-lg-9">
	                    <input class="form-control" name="keyword" id="" type="text" value="{$_GPC['keyword']}" placeholder="请输入页面名称进行搜索">
	                </div>
	                <div class=" col-xs-12 col-sm-2 col-lg-2">
	                    <button class="btn btn-default"><i class="fa fa-search"></i> 搜索</button>
	                </div>
	            </div>
	        </form>
	    </div>
	</div>
	<!-- 页面列表 -->
	<style type="text/css">
		@media (min-width: 100px) and (max-width: 640px) {
			
		}		
		/*店铺装修 首页 部分样式*/
		.row{margin-right:-15px;margin-left:-15px}
		.item { border: 1px solid #e7eaec; height: 420px; width: 266px;float: left; margin-left: 15px; margin-bottom: 15px; position: relative; overflow: hidden;}
		.item iframe { display: block; display: block;width: 272px;height: 100%;}
		.item .title { height: 40px; width: 100%; display: none; position: absolute; bottom: 0; left: 0; color: #fff; font-size: 14px; text-align: center; line-height: 40px; z-index: 2; }
		.item .cate .label,.item .title .label { margin-right: 2px; padding: 2px 4px; font-weight: 100; }
		.item .mask { position: absolute; background: rgba(0, 0, 0, 0.6); top: 0; left: 0; right: 0; bottom: 0; display: none; z-index: 1 }
		.item .btns { height: auto; width: 60%; position: absolute; top: 120px; left: 50%; margin-left: -30%; }
		.item .btns .btn { margin-bottom: 10px; }
		.item .cate { position: absolute; top: 10px; left: 10px; right: 10px; height: 40px; z-index: 1; padding: 10px;}

		.btn{display:inline-block;padding:6px 12px;margin-bottom:0;font-size:14px;font-weight:400;line-height:1.42857143;text-align:center;white-space:nowrap;vertical-align:middle;-ms-touch-action:manipulation;touch-action:manipulation;cursor:pointer;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;background-image:none;border:1px solid transparent;border-radius:4px}
		.btn { border-radius: 3px; }
		.btn-primary { background-color: #1ab394; border-color: #1ab394; color: #FFFFFF; }
		.btn-sm{padding:5px 10px;font-size:12px;line-height:2.5;border-radius:3px}
		.btn-block+.btn-block{margin-top:5px}
		.btn-block{display:block;width:100%}
		.btn-default { color: inherit; border: 1px solid #e7eaec; }
	</style>
	<div class="panel-show">
	    <div class='panel-heading'> 页面管理 {if $pagesnum}(总数: {$pagesnum}){/if}</div>
		<div class="panel-body">
			<div class='panel_heading_width' style=" width: 1480px;float: left; padding: 0; margin-top: 10px;">
				<div class="row" style="position:relative">
					{if !empty($pages)}
					{loop $pages $page}
					<div class="item" pageid="{$page['id']}">
						<iframe src="{php echo $this->createPluginMobileUrl('designer',array('pageid'=>$page['id']));}" frameborder="0"></iframe>
						<div class="cate">
							<span class="label label-primary">{$page['id']}</span>
							<span class="label label-primary">系统</span>
							<span class="label label-warning">
								{if $page['pagetype']==1}
                                	<label class='label label-primary'>店铺首页</label>
                                {elseif $page['pagetype']==2}
                                	<label class='label label-success'>商品列表</label>
                                {elseif $page['pagetype']==3}
                                	<label class='label label-warning'>商品详细</label> 
                                {elseif $page['pagetype']==4}
                                	<label class='label label-danger'>其他自定义</label> 
                                {/if}
							</span>
						</div>
						<div class="title" style="display: none; opacity: 1;">{$page['pagename']}</div><!--页面名称-->
						<div class="mask" style="display: none; opacity: 1;">
							<div class="btns">
								{ifp 'designer.page.edit'}<a class="btn btn-primary btn-block btn-sm create"  title="创建页面" href="{php echo $this->createPluginWebUrl('designer/all_template',array('op'=>'post','pageid'=>$page['id']))}">创建页面</a>{/if}
								{ifp 'designer.page.delete'}<a class="btn btn-default btn-block btn-sm delete" title="删除模板" href="javascript:;" onclick="delpage({$page['id']})">删除模板</a>{/if}
							</div>
						</div>
					</div>
					{/loop}
					{else}
					{ifp 'designer.page.edit'}
					<table class="table">
						<tbody>
						<tr>
							<td style="text-align: center; line-height: 100px;" colspan="8">亲~您还没有添加自定义页面哦~您可以尝试 ↙ 左下角的 “<a href="{php echo $this->createPluginWebUrl('designer/all_template', array('op' => 'post'))}">添加一个模板</a>”</td>
						</tr>
						</tbody>
					</table>
					{/if}
					{/if}
					{ifp 'designer.page.edit'}
					<table class="table">
						<tbody>
						<tr><td colspan="8">
							<a class='btn btn-primary' href="{php echo $this->createPluginWebUrl('designer/all_template', array('op' => 'post'))}"><i class="fa fa-plus"></i> 添加一个模板</a>
							<span>Tips:自定义页面启用默认后将代替系统默认页面(商城首页、商品列表、商品详细)，同一个类型的页面仅允许设置一个默认页面</span>
						</td>
						</tr>
						</tbody>
					</table>
					{/if}
					<!--页数-->
					<table class="table">
						<tbody>
						<tr><td colspan="8" style="padding:0px; margin: 0px;">{$pager}</td></tr>
						</tbody>
					</table>
				</div>
				<script type="text/javascript">
					$(".item").hover(function () {
						$(this).find('.mask').stop().fadeIn();
						$(this).find('.title').stop().fadeIn();
					}, function () {
						$(this).find('.mask').stop().fadeOut();
						$(this).find('.title').stop().fadeOut();
					});
				</script>
			</div>
		</div>
	</div>
	<script type="text/javascript">
	    function delpage(id){
	        if(confirm('此操作不可恢复，确认删除？')){
	        	
                 if (id) {
                            $.ajax({
                            type: 'POST',
                            url: "{php echo $this->createPluginWebUrl('designer',array('op'=>'api','apido'=>'delpage'))}",
                            data: {pageid:id},
                            success: function(data){
                                if(data=='success'){
                                    $("div[pageid="+id+"]").fadeOut();
                                }else{
                                	if(data=='lose'){
	                                    alert('预定义模板无法删除');
                                	}else{
	                                    alert('删除成功');
	                                    history.go(0);
                                	}
                                }
                            },
                            error: function(){
                                alert('操作失败~请刷新页面重试！');
                            }
                        })
               
               	 } else {
                    alert('网络异常！请重新操作！');
            }
        }
	}
	</script>
	{elseif $op=='post'}
	<!-- 编辑页面 -->
	<!--新加入的样式-->
	<link href="../addons/sz_yi/plugin/designer/template/index_modification.css" rel="stylesheet">
	<style type="text/css">
		@media (max-width: 1366px) {
			.fe{
				margin-left: 190px!important;}
			.fe-panel-menu{width: 180px!important;}
		}		@media (min-width: 1420px) {
			.fe{    margin-left: 300px;}
			.fe-panel-menu{width: 288px;}
		}
		.fe-panel-menu .fe_panel_menu_top{
			width:auto;overflow:visible;height:55px;color:#303b49;font-size:16px;border-top:1px solid #fff;padding:0 10px;
			FILTER: progid:DXImageTransform.Microsoft.Gradient(gradientType=0,startColorStr=#eceef2,endColorStr=#dcdce1); /*IE 6 7 8*/
			background: -ms-linear-gradient(top, #eceef2,  #dcdce1);        /* IE 10 */
			background:-moz-linear-gradient(top,#eceef2,#dcdce1);/*ç«ç‹*background:-webkit-gradient(linear, 0% 0%, 0% 100%,from(#f8fafa), to(#e9edf0));/*è°·æ­Œ*/
			background: -webkit-gradient(linear, 0% 0%, 0% 100%, from(#eceef2), to(#dcdce1)); /* Safari 4-5, Chrome 1-9*/
			background: -webkit-linear-gradient(top, #eceef2, #dcdce1);   /*Safari5.1 Chrome 10+*/
			background: -o-linear-gradient(top, #eceef2, #dcdce1);  /*Opera 11.10+*/
		}
		.fe-save-submit1 {height: 40px; width: 100px; background: #f8ac59; border-radius: 3px; text-align: center; line-height: 40px; color: #fff; font-size: 16px; margin: 10px 0px; cursor: pointer; margin:10px 0px; float: left;}
		.fe-save-submit3 { background: #fff url(../addons/sz_yi/plugin/designer/template/images/get_back.png) no-repeat center left; background-size: 30px 30px;text-indent: 30px; color: #000;
					height: 40px; width: 100px; border-radius: 3px; text-align: center; line-height: 40px; font-size: 16px; margin: 10px 0px; cursor: pointer; margin:10px 0px; float: left;}
		.fe-panel-menu nav{ margin: 2px 5px;}		.fe-save-submit2{ color: #fff; background: #4bb5fb; margin: 10px 10px; }
	</style>
	<div class="w1200">
		<div class="panel-show" ng-app="FoxEditor" style="background: #f2f2f2">
		    <div class='panel-heading'>页面编辑 {if $_GPC['pageid']!=''}(ID: {$_GPC['pageid']}){/if}</div>
		    <div class='panel-body' ng-controller="FoxController" style="position: relative;">
		    	<div class="fe-panel-menu" style=" width:288px; position:absolute; top:60px; border-radius: 5px; border: 1px #ccc solid; background: #E6E8EA; border-bottom: 1px solid #fff; box-shadow: 0px 4px 8px rgba(0,0,0,0.36);">
		    		<div class="fe_panel_menu_top">
		    			<div class="phonebox_functionbox_title"><div class="phonebox_functionbox_titleicon"></div> 功能插件</div>
		    		</div>
		    		<div class="phonebox_functionbox_contentbox Tools_EditBox Tools_FunctionIcon" id="mobile_plugin_select" style="height: 486px; background: #fff;">
		    			<div ng-repeat="nav in navs"  >
			                <nav ng-bind="nav.name" draggable="true" ng-click="addItem(nav.id)"></nav>
			           </div>
		    		</div>
		        </div>
		        <div class="fe" style="margin-left: 300px;">
		            <div class="fe-phone">
		                <div class="fe-phone-left"></div>
		                <div class="fe-phone-center">
		                    <div class="fe-phone-top"></div>
		                    <div class="fe-phone-main">
		                        <div id="editor" style=" overflow-y: scroll; max-height: 600px;">
		                            <div ng-repeat="page in pages">
		                                <div ng-include="'../addons/sz_yi/plugin/designer/template/temp/show-'+page.temp+'.html'" id="{{page.id}}" mid="{{page.id}}" ng-click="setfocus(page.id,$event)"></div>
		                            </div>
		                            <div style="height: 50px;" ng-show="pages[0].params.guide==1"></div>
		                            <div ng-repeat="Item in Items" class="fe-mod-repeat" ng-mouseover="over(Item.id)" ng-mouseleave="out(Item.id)">
		                                <div class="fe-mod-move" ng-mouseover="drag(Item.id)" ng-click="setfocus(Item.id,$event)"></div>
		                                <div ng-include="'../addons/sz_yi/plugin/designer/template/temp/show-'+Item.temp+'.html'" class="fe-mod-parent" id="{{Item.id}}" ng-show="Item" mid="{{Item.id}}" on-finish-render-filters></div>
		                                <div class="fe-mod-del" ng-click="delItem(Item.id)">移除</div>
		                            </div>
		                            <!-- 浮动按钮 -->
		                            <div class="fe-floatico" ng-show="pages[0].params.floatico==1" ng-style="{'width':pages[0].params.floatwidth,'top':pages[0].params.floattop}" ng-class="{'fe-floatico-right':pages[0].params.floatstyle=='right'}">
		                                <img ng-src="{{pages[0].params.floatimg || '../addons/sz_yi/plugin/designer/template/imgsrc/init-data/init-image-7.png'}}" style="height:100%; width: 100%;" ng-click="setfocus('M0000000000000')" />
		                            </div>
		                            <!-- 关注按钮 -->
		                            <div class="fe-guide" ng-click="setfocus('M0000000000000')" ng-show="pages[0].params.guide==1" ng-style="{'display':'block','background-color':pages[0].params.guidebgcolor,'top':'60px','z-index':'890','opacity':pages[0].params.guideopacity}">
		                                <div class="fe-guide-faceimg"><img ng-src="../addons/sz_yi/plugin/designer/template/imgsrc/init-data/init-icon.png" ng-style="{'border-radius':pages[0].params.guidefacestyle}" /></div>
		                                <div class="fe-guide-sub" ng-style="{'color':pages[0].params.guidenavcolor,'background-color':pages[0].params.guidenavbgcolor}">{{pages[0].params.guidesub ||'立即关注'}}</div>
		                                <div class="fe-guide-text"  ng-style="{'font-size':pages[0].params.guidesize,'color':pages[0].params.guidecolor}">
		                                    <p ng-class="{'fe-guide-lineheight':pages[0].params.guidetitle2==''}">{{pages[0].params.guidetitle1s || '加关注，做代理。'}}</p>
		                                    <p ng-class="{'fe-guide-lineheight':pages[0].params.guidetitle1==''}">{{pages[0].params.guidetitle2s || '关注公众号，享专属服务'}}</p>
		                                </div>
		                            </div>
		                        </div>
		                    </div>
		                    <div class="fe-phone-bottom"></div>
		                </div>
		                <div class="fe-phone-right"></div>
		            </div>
		            <div class="fe-panel">
		                <!-- editor start -->
		                <div class="fe-panel-editor" ng-show="focus">
		                    <div class="fe-panel-editor-ico"></div>
		                    <div ng-repeat="Edit in pages">
		                        <div ng-include="'edit-'+Edit.temp+'.html'" ng-show="focus==Edit.id" Editid="{{Edit.id}}" ></div>
		                    </div>
		                    <div ng-repeat="Edit in Items">
		                        <div ng-include="'edit-'+Edit.temp+'.html'" ng-show="focus==Edit.id" Editid="{{Edit.id}}" tab-index="-1"></div>
		                    </div>
		                </div>
		                <!-- editor end -->
		            </div>
		        </div>
		        <!--当前编辑页面-->
	            <div class="phonebox_functionshadow" style="display: none;">
					<div class="phonebox_functionborder">
						<div class="phonebox_functionbox">
							<div class="phonebox_functionbox_titlebox">
								<div class="phonebox_functionbox_title"><div class="phonebox_pagelistbox_titleicon"></div>当前编辑页面</div>
								<div class="phonebox_pagelistbox_add" id="add_mobile_page"></div>
							</div>
							<div class="phonebox_pagelistbox_contentbg">
								<div class="phonebox_pagelistbox_contentbox" id="mobile_page_select"><div value="9261587" type="0" page_id="9261587" index_id="0" class="phonebox_pagelistbox_contentbox_listchecked">         <div class="phonebox_pagelistbox_contentbox_listnumber">1</div>         <div class="phonebox_pagelistbox_contentbox_listname j_edit_mobile_page_name">首页</div>         <div class="phonebox_pagelistbox_contentbox_listedit j_edit_mobile_page"></div>     </div></div>
							</div>
						</div>
					</div>
				</div>
	            <!--当前编辑页面结束-->
		        <!-- 页面底部保存栏 -->
		        <div class="fe-save">
		            <div class="fe-save-main" style="width: 1180px;">
		                <div class="fe-save-info" style="width: 730px;">
		                    <div class="fe-save-info-type fe-save-info-type-ok" data-type="1">
		                        {if $datas['pagetype']==1 || empty($datas['pagetype'])}
		                            <div class="fe-save-main-radio fe-save-main-radio2">√</div>
		                        {else}
		                            <div class="fe-save-main-radio"></div>
		                        {/if}
		                        <div class="fe-save-main-text">商城首页</div>
		                    </div>	
		                    <div class="fe-save-info-type fe-save-info-type-ok" data-type="4">
		                        {if $datas['pagetype']==4}
		                            <div class="fe-save-main-radio fe-save-main-radio2">√</div>
		                        {else}
		                            <div class="fe-save-main-radio"></div>
		                        {/if}
		                        <div class="fe-save-main-text">其他自定义页面</div>
		                    </div>
		
		                    <div class="fe-save-info-type" data-type="2">
		                        {if $datas['pagetype']==2}
		                            <div class="fe-save-main-radio fe-save-main-radio2">√</div>
		                        {else}
		                            <div class="fe-save-main-radio" style="border:2px solid #999; cursor: no-drop;"></div>
		                        {/if}
		                        <div class="fe-save-main-text" style="color:#999; cursor: no-drop;">商品列表</div>
		                    </div>	
		                    <div class="fe-save-info-type" data-type="3">
		                        {if $datas['pagetype']==3}
		                            <div class="fe-save-main-radio fe-save-main-radio2">√</div>
		                        {else}
		                            <div class="fe-save-main-radio" style="border:2px solid #999; cursor: no-drop;"></div>
		                        {/if}
		                        <div class="fe-save-main-text" style="color:#999; cursor: no-drop;">商品详细</div>
		                    </div>
		                    <input name="pagetype" type="hidden" value="{if empty($datas['pagetype'])}1{else}{$datas['pagetype']}{/if}" />
		                    <input name="pagename" type="text" style="height: 30px; width: 300px; border: 1px solid #bbb; border-radius: 3px; margin: 4px 10px; outline: none; padding-left: 10px;" placeholder="页面名称：快来给你的页面起一个响亮的名字" value="{$datas['pagename']}"/>
		                </div>
		                <div class="fe-save-submit1" ng-click="save(3)" data-type="savetemp">保存</div>
		                <div class="fe-save-submit" ng-click="save(1)" style="margin-left: 10px;">保存为页面</div>
						<div class="fe-save-submit2" ng-click="save(2)">保存并预览</div>
						<div class="fe-save-submit1" ng-click="save(4)" data-type="savetemp">另存为模版</div>
		                <div class="fe-save-submit3" onclick="history.back()" style=" width: 120px;">返回列表</div>
		            </div>
		            <div class="fe-save-fold" onclick="fold()"></div>
		            <div class="fe-save-gotop" onclick="$(document.body).animate({scrollTop:0},500)"><i class="fa fa-angle-up"></i><br>返回顶部</div>
		            {template 'modal'}
		        </div>
		    </div>							
			<!-- editor template  page start -->
			<script type="text/ng-template" id="edit-topbar.html">{template 'temp/edit-topbar'}</script>
			<script type="text/ng-template" id="edit-shop.html">{template 'temp/edit-shop'}</script>
			<script type="text/ng-template" id="edit-notice.html">{template 'temp/edit-notice'}</script>
			<script type="text/ng-template" id="edit-menu.html">{template 'temp/edit-menu'}</script>
			<script type="text/ng-template" id="edit-banner.html">{template 'temp/edit-banner'}</script>
			<script type="text/ng-template" id="edit-picture.html">{template 'temp/edit-picture'}</script>
			<script type="text/ng-template" id="edit-title.html">{template 'temp/edit-title'}</script>
			<script type="text/ng-template" id="edit-search.html">{template 'temp/edit-search'}</script>
			<script type="text/ng-template" id="edit-line.html">{template 'temp/edit-line'}</script>
			<script type="text/ng-template" id="edit-blank.html">{template 'temp/edit-blank'}</script>
			<script type="text/ng-template" id="edit-goods.html">{template 'temp/edit-goods'}</script>
			<script type="text/ng-template" id="edit-richtext.html">{template 'temp/edit-richtext'}</script>
			<script type="text/ng-template" id="edit-cube.html">{template 'temp/edit-cube'}</script>
			<!-- editor template page end -->
		</div>
	</div>
	<script type="text/javascript" src="../addons/sz_yi/plugin/designer/template/imgsrc/angular.min.js"></script>
	<script type="text/javascript" src="../addons/sz_yi/plugin/designer/template/imgsrc/angular-ueditor.js"></script>
	<script type="text/javascript" src="../addons/sz_yi/plugin/designer/template/imgsrc/hhSwipe.js"></script>
	<script type="text/javascript" src="./resource/components/ueditor/ueditor.config.js"></script>
	<script type="text/javascript" src="./resource/components/ueditor/ueditor.all.min.js"></script>
	<script type="text/javascript" src="./resource/components/ueditor/ueditor.parse.js"></script>
	<script type="text/javascript" src="./resource/components/ueditor/lang/zh-cn/zh-cn.js"></script>
	<script type="text/javascript">
		// 百度编辑器初始化
		var opts = {type: 'image',direct: false,multi: true,tabs: {'upload': 'active','browser': '','crawler': ''},path: '',dest_dir: '',global: false,thumb: false,width: 0};
		UE.registerUI('myinsertimage',function(editor, uiName) {
		    editor.registerCommand(uiName, {
		        execCommand: function() {
		            require(['fileUploader'],
		            function(uploader) {
		                uploader.show(function(imgs) {
		                    if (imgs.length == 0) {
		                        return;
		                    } else if (imgs.length == 1) {
		                        editor.execCommand('insertimage', {
		                            'src': imgs[0]['url'],
		                            '_src': imgs[0]['attachment'],
		                            'width': '100%',
		                            'alt': imgs[0].filename
		                        });
		                    } else {
		                        var imglist = [];
		                        for (i in imgs) {
		                            imglist.push({
		                                'src': imgs[i]['url'],
		                                '_src': imgs[i]['attachment'],
		                                'width': '100%',
		                                'alt': imgs[i].filename
		                            });
		                        }
		                        editor.execCommand('insertimage', imglist);
		                    }
		                },
		                opts);
		            });
		        }
		    });
		    var btn = new UE.ui.Button({
		        name: '插入图片',
		        title: '插入图片',
		        cssRules: 'background-position: -726px -77px',
		        onclick: function() {
		            editor.execCommand(uiName);
		        }
		    });
		    editor.addListener('selectionchange',
		    function() {
		        var state = editor.queryCommandState(uiName);
		        if (state == -1) {
		            btn.setDisabled(true);
		            btn.setChecked(false);
		        } else {
		            btn.setDisabled(false);
		            btn.setChecked(state);
		        }
		    });
		    return btn;
		},
		19);	
	</script>
	<script type="text/javascript">
	    $(function(){
	        require(['util'], function (util) {
	            var preview_id = util.cookie.get('preview_id');
	            if(preview_id){
	                preview(preview_id);
	            }
	        });
	
	       $(".fe-save-info-type-ok").click(function(){
	           var pagetype = $(this).data("type");
	           if(pagetype!='2' || pagetype!='3'){
	                $(this).find(".fe-save-main-radio").addClass("fe-save-main-radio2").text("√");
	                $(this).siblings().find(".fe-save-main-radio").removeClass("fe-save-main-radio2").text("");
	           }
	           $("input[name=pagetype]").val(pagetype);
	       }); 
	    });
	    function switchtab(tag,n){
	        $("#"+tag+"-"+n).fadeIn().siblings().hide();
	        $("#"+tag+"-nav-"+n).addClass("active").siblings().removeClass("active");
	    }
	    function fold(){
	        width= $(".fe-save").width();
	        left = $(".fe-save").css("left");
	        left = left.replace("px","");
	        if(left>=0){
	            $(".fe-save").animate({left:0-width+40+"px"},1000);
	            $(".fe-save-fold").addClass("fe-save-fold2");
	        }else{
	            $(".fe-save").animate({left:"0px"},1000);
	            $(".fe-save-fold").removeClass("fe-save-fold2");
	        }
	    }
	    function preview(pageid){
	        var url = "{php echo $this->createPluginMobileUrl('designer')}&preview=1&pageid="+pageid;
	        $('#modal-module-menus3').find("iframe").attr("src",url);
	        popwin = $('#modal-module-menus3').modal();
	        require(['util'], function (util) {
	            util.cookie.set('preview_id','');
	        });
	    }
	    function setcookie(id){
	        require(['util'], function (util) {
	            util.cookie.set('preview_id',id);
	        });
	    }
	    function clone(myObj){
	        if(typeof(myObj) != 'object' || myObj == null) return myObj;
	        var newObj = new Object();
	        for(var i in myObj){
	            newObj[i] = clone(myObj[i]);
	        }
	        return newObj;
	    }
	    function cloneArr(arr){
	        var newArr = [];
	        $(arr).each(function(i,val){ 
	            newArr.push(clone(val));
	        });
	        return newArr;
	    }
	    function initswipe(jobj){
	        var bullets = jobj.next().get(0).getElementsByTagName('a');
	        var banner = Swipe(jobj.get(0), {
	            auto: 2000,
	            continuous: true,
	            disableScroll:false,
	            callback: function(pos) {
	                var i = bullets.length;
	                while (i--) {
	                    bullets[i].className = '';
	                }
	                bullets[pos].className = 'cur';
	            }
	        })
	    }
	    var myModel = angular.module('FoxEditor',['ng.ueditor']);
	    myModel.controller('FoxController', ['$scope', function($scope){
	            $scope.navs = [
	                {id:'notice',name:'公告',params:{color:'',bgcolor:'',notice:'',noticehref:'',scroll:'0'}},
	                {id:'banner',name:'轮播广告',params:{shape:'',align:'center',scroll:'2',bgcolor:''},
	                   data:[
	                       {id:'B0000000000001',imgurl:'../addons/sz_yi/plugin/designer/template/imgsrc/init-data/init-image-3.jpg',hrefurl:'http://www.baidu.com',sysurl:'url',},
	                       {id:'B0000000000002',imgurl:'../addons/sz_yi/plugin/designer/template/imgsrc/init-data/init-image-2.jpg',hrefurl:'http://www.qq.com',sysurl:'url'},
	                       {id:'B0000000000003',imgurl:'../addons/sz_yi/plugin/designer/template/imgsrc/init-data/init-image-6.jpg',hrefurl:'http://www.sina.com',sysurl:'url'}
	                   ]
	                },
	                {id:'title',name:'标题',params:{title1:'',title2:'',showtitle2:'1',fontsize1:'18px',fontsize2:'14px',align:'left',color:'#000',}},
	                {id:'search',name:'搜索框',params:{placeholder:'搜索：输入关键字在店内搜索',style:'style1','color':'','bgcolor':'','bordercolor':'',searchurl:'{php echo $this->createMobileUrl("shop/list")}',uniacid:'{$_W["uniacid"]}'}},
	                {id:'line',name:'辅助线',params:{height:'2px',style:'dashed',color:'#000'}},
	                {id:'blank',name:'辅助空白',params:{height:'100px',bgcolor:''}},
	                {id:'shop',name:'店招',params:{style:'1',bgimg:'../addons/sz_yi/plugin/designer/template/imgsrc/init-data/init-image-1.jpg',logo:'1',name:'1',menu:'1',navcolor:''},
	                   data:['{php echo $this->createMobileUrl("shop/index")}','{php echo $this->createMobileUrl("shop/list")}','{php echo $this->createMobileUrl("shop/list",array("isdiscount"=>"1"))}','{php echo $this->createMobileUrl("shop/notice")}']
	                },
	                {id:'goods',name:'商品组',params:{style:'50%',showtitle:'0',titlecolor:'',bgcolor:'',showname:'1',title:'',option:'sale-rx',buysub:'buy-3',price:'1',goodhref:'{php echo $this->createMobileUrl("shop/detail")}'},data:[]},
	                {id:'richtext',name:'富文本',params:{bgcolor:'',},content:''},
	                {id:'menu',name:'按钮组',params:{num:'20%',style:'0',bgcolor:'#fff',},
	                    data:[{id:'F0000000000001',imgurl:'',text:'',hrefurl:'',color:''},{id:'F0000000000002',imgurl:'',text:'',hrefurl:'',color:''},{id:'F0000000000003',imgurl:'',text:'',hrefurl:'',color:''},{id:'F0000000000004',imgurl:'',text:'',hrefurl:'',color:''},{id:'F0000000000005',imgurl:'',text:'',hrefurl:'',color:''}]
	                },
	                {id:'picture',name:'单图展示',params:{},data:[{id:'P0000000000001',imgurl:'../addons/sz_yi/plugin/designer/template/imgsrc/init-data/init-image-4.jpg',hrefurl:'',option:'0'}]},
	                {id: "cube",name: "图片魔方",params: {bgcolor:'',layout: {},showIndex: 0,selection: {},currentPos: {},currentLayout: {isempty: !0}},data:[]}
	                
	            ];
	            $scope.shop = {uniacid:'{$_W["uniacid"]}'};
	            $scope.system = [{$system}];
	            $scope.pages = [{$pageinfo}];
	            $scope.Items = [{$data}];
	            $scope.underscore = null;
	            require(['underscore'],function(underscore){
	                $scope.underscore = underscore;
	            });
	            $scope.hasCube = function(Item){
	            	 var has = false;
	                 var row=0,col = 0;
	            	 for(var i=row;i<4;i++){
	                    for(var j=col;j<4;j++){
	                      if (!$scope.underscore.isUndefined(Item.params.layout[i][j]) && !Item.params.layout[i][j].isempty) {
	                          has = true;
	                          break;
	                      }
	                    }
	               }
	                return has;
	            }
	            $scope.showSelection = function(Edit, row,col){
	                Edit.params.currentPos = {row: row,col: col};
	                Edit.params.selection = {};
	                var maxrow = 4,maxcol = 4,end =false;
	                for(var i=row;i<=3;i++){
	                	
	                    if ($scope.underscore.isUndefined(Edit.params.layout[i][col]) || !$scope.underscore.isUndefined(Edit.params.layout[i][col]) && !Edit.params.layout[i][col].isempty) {
	                        maxrow = i;
	                        end =true;
	                    }
	                    if(end){
	                        break;
	                    }
	                }
	          
	                end =false;
	                for(var j=col;j<=3;j++){
	                    if ( $scope.underscore.isUndefined(Edit.params.layout[row][j]) || !$scope.underscore.isUndefined(Edit.params.layout[row][j]) && !Edit.params.layout[row][j].isempty) {
	                        maxcol = j;
	                        end =true;
	                    } 
	                    if(end){
	                        break;
	                    }
	                }
	                
	                var f = -1,g = 1;
	              
	                for (var i = row; i < maxrow; i++) {
		                
	                    var y = 1;
	                    Edit.params.selection[g] = {};
	                    for (var j = col; j < maxcol; j++) {
	                      if( f >= 0 && f < j || (!$scope.underscore.isUndefined(Edit.params.layout[i][j]) && Edit.params.layout[i][j].isempty   )){
	                          Edit.params.selection[g][y] = {
	                            rows: g,
	                            cols: y
	                          };
	                          y++;
	                      }
	                      else{
	                          f = j - 1
	                      }
	                    } 
	                    g++;
	                }
	                
	                $(".layout-table li").removeClass("selected");
	                $scope.modalobj = $("#"+Edit.id+"-modal-cube-layout").modal({show:true});
	                $('#'+Edit.id+'-modal-cube-layout').find(".layout-table").unbind('mouseover').mouseover(function(a) {
	                    if ("LI" == a.target.tagName) {
	                        $(".layout-table li").removeClass("selected");
	                        var c = $(a.target).attr("data-rows"),
	                              d = $(a.target).attr("data-cols");
	                        $(".layout-table li").filter(function(a, e) {
	                            return $(e).attr("data-rows") <= c && $(e).attr("data-cols") <= d
	                        }).addClass("selected")
	                    }
	                });
	                
	                return true;
	            }
	            $scope.selectLayout = function(Edit, currentRow, currentCol, rows, cols) {
	                if( $scope.underscore.isUndefined(rows) ) {rows= 0;}
	                if( $scope.underscore.isUndefined(cols) ) {cols = 0;}
	                Edit.params.layout[currentRow][currentCol] = {
	                    cols: cols,
	                    rows: rows,
	                    isempty: false,
	                    imgurl: "",
	                    classname: "index-" + Edit.params.showIndex
	                };
	                for (var i = parseInt(currentRow); i < parseInt(currentRow) + parseInt(rows); i++){
	                    for (var j = parseInt(currentCol); j < parseInt(currentCol) + parseInt(cols); j++) {
	                        if( currentRow != i || currentCol != j)  {
	                            delete Edit.params.layout[i][j];
	                        } 
	            	}
	                }
	                Edit.params.showIndex++;
	                $scope.modalobj.modal('hide');
	                $scope.changeItem(Edit, currentRow,currentCol);   
	                return true;
	            }
	            $scope.changeItem = function(Edit,row,col){
	                $("#cube-editor td").removeClass("current").filter(function(a, e) {
	                    return $(e).attr("x") == row && $(e).attr("y") == col
	                }).addClass("current");
	                $("#cube_thumb").attr("src", "");
	                Edit.params.currentLayout = Edit.params.layout[row][col];
	            }
	            $scope.delCube = function(Edit,Cid,cols,rows){
	                if(Edit && Cid && cols && rows){
	                    var len = Edit.params.layout.length;
	                    $.each(Edit.params.layout,function(row,a){
	                        $.each(Edit.params.layout[row],function(col,b){
	                            if(col!='$$hashKey'){
	                                if(b.classname==Edit.params.currentLayout.classname){
	                                    row  =parseInt(row);col = parseInt(col);
	                                    rows  =parseInt(rows);cols = parseInt(cols);
	                                     for(var i = row;i<row+rows;i++){
	                                         for(var j=col;j<col+cols;j++){
	                                            Edit.params.layout[i][j] = {cols: 1,rows: 1,isempty: true,imgurl: "",classname: ""};
	                                         }
	                                     }
	                                }
	                            }
	                        });
	                        
	                    });
	                }
	            }
	            // 1.1 添加一条子级(good,picture,banner)
	            $scope.addItemChild =function(type,Mid){
	                if(type && Mid){
	                    t = '';
	                    if(type=='good'){t = 'G';}
	                    else if(type=='picture'){t = 'P';}
	                    else if(type=='banner'){t = 'B';}
	                    var var_id = t+new Date().getTime();
	                    var push = {
	                        banner:{id:var_id,imgurl:'',hrefurl:'',sysurl:'url'},
	                        picture:{id:var_id,imgurl:'',hrefurl:'',option:'0'},
	                        good:{}
	                    };
	                    var Items = $scope.Items;
	                    angular.forEach(Items, function(m,index) {
	                        if(m.id==Mid){
	                            m.data.push(push[type]);
	                            //console.log(push[type]);
	                        }
	                    });
	                }
	            }
	            // 1.1 删除一条子级
	            $scope.delItemChild = function(Mid,Cid){
	                if(confirm("此操作不可逆，确认移除？")){
	                    var Items = $scope.Items;
	                    angular.forEach(Items, function(m,index1) {
	                        if(m.id==Mid){
	                            angular.forEach(m.data, function(c,index2) {
	                                if(c.id==Cid){
	                                    m.data.splice(index2,1);
	                                }
	                            });
	                        }
	                    });
	                }
	            }
	            // 1.1 上传图片
	            $scope.uploadImgChild = function(Mid,Cid,Type){
	                require(['jquery', 'util'], function($, util){
	                    util.image('',function(data){
                            var Items = $scope.Items;
                            angular.forEach(Items, function(m,index1) {
                                if(m.id==Mid){
                                    if(Type=='cube'){
                                        m.params.currentLayout.imgurl = data['url'];
                                        $("div[mid="+Mid+"]").mouseover();
                                        
                                    }else{
                                        angular.forEach(m.data, function(c,index2) {
                                            if(c.id==Cid){
                                                c.imgurl = data['url'];
                                                $("div[mid="+Mid+"]").mouseover();
                                                //console.log(Items);
                                            }
                                        });
                                    }
                                }
                            });
	                    });
	                });
	            }
	            $scope.chooseUrlCube = function(Mid,Cid){
	                var Items = $scope.Items;
	                angular.forEach(Items, function(m) {
	                    if(m.id==Mid){
	                        m.params.currentLayout.url = 'http://www.qq.com';
	                        $("div[mid="+Mid+"]").mouseover();
	                    }
	                });
	            }
	            // 1.1 选择链接
	            $scope.chooseUrl = function(Mid,Cid,T){
	                $('#floating-link').attr({"Mid":Mid,"Cid":Cid,T:T});
	                $('#floating-link').modal();
	            }
	            $scope.chooseLink = function(type,hid){
	                var Mid = $('#floating-link').attr("Mid");
	                var Cid =  $('#floating-link').attr("Cid");
	                var T =  $('#floating-link').attr("T");
	                var url = $("#fe-tab-link-"+type+" #fe-tab-link-li-"+hid).data("href");
	                if(url && Mid && Cid){
	                    angular.forEach($scope.Items, function(m,index1) {
	                        if(m.id==Mid){
	                            if(T=='cube'){
	                                m.params.currentLayout.url = url;
	                                $("div[mid="+Mid+"]").mouseover();
	                            }else{
	                                angular.forEach(m.data, function(c,index2) {
	                                    if(c.id==Cid){
	                                        c.hrefurl = url;
	                                    }
	                                });
	                            }
	                        }
	                    });
	                    $('#floating-link').attr({"Mid":'',"Cid":'',T:''});
	                    $('#floating-link .close').click();
	                }
	            }
	            $scope.temp = {
	                notcie:[]
	            };
	            $scope.ajaxselect =function(type){
	                val = $("#select-"+type+"-kw").val();
	                mid = $("#floating-link").attr("mid");
	                $.ajax({
	                    type: 'post',
	                    dataType:'json',
	                    url: "{php echo $this->createPluginWebUrl('designer',array('op'=>'api','apido'=>'selectlink'))}",
	                    data: {kw:val,type:type},
	                    success: function(data){
	                        $scope.temp[type]=data;
	                        $("div [mid="+mid+"]").mouseover();
	                    },
	                    error: function(){
	                        alert('查询失败！请刷新页面。');
	                    }
	                });
	            }
	            $scope.focus = 'M0000000000000';
	            $scope.keyword = function(val,Eid){
	                $.ajax({
	                    type: 'post',
	                    url: "{php echo $this->createPluginWebUrl('designer',array('op'=>'api','apido'=>'selectkeyword'))}",
	                    data: {kw:val,pid:"{$pageid}"},
	                    success: function(data){
	                        if(data != 'ok'){
	                            window.dosave = '1';
	                            $("div[Editid="+Eid+"]").find(".keyword").css('border',"#f01 solid 1px");
	                        }else{
	                            window.dosave = '0';
	                            $("div[Editid="+Eid+"]").find(".keyword").css('border',"#ddd solid 1px");
	                        }
	                    },
	                    error: function(){
	                        alert('查询商品信息失败！请刷新页面。');
	                    }
	                });
	            }
	            $scope.selectgood = function(Mid){
	                kw = $("#secect-kw").val();
	                $.ajax({
	                    type: 'post',
	                    dataType:'json',
	                    url: "{php echo $this->createPluginWebUrl('designer',array('op'=>'api','apido'=>'selectgood'))}",
	                    data: {kw:kw},
	                    success: function(data){
	                        $scope.selectGoods = [];
	                        angular.forEach(data, function(d,i) {
	                            Sid = 'S'+new Date().getTime();
	                            $scope.selectGoods.push({id:Sid+i,name:data[i].title,img:data[i].thumb,goodid:data[i].id,pricenow:data[i].marketprice,priceold:data[i].productprice,sales:data[i].sales,unit:data[i].unit});
	                        });
	                        $("div[mid="+Mid+"]").mouseover();
	                    },
	                    error: function(){
	                        alert('查询商品信息失败！请刷新页面。');
	                    }
	                });
	            }
	            $scope.pushGood = function(Mid,Sid){
	                var repaction =  $('#floating-good').attr("action");
	                var repGid =  $('#floating-good').attr("Gid");
	                angular.forEach($scope.Items, function(m,index1) {
	                    if(m.id==Mid){
	                        angular.forEach($scope.selectGoods, function(s,index2) {
	                            if(s.id==Sid){
	                                if(repaction=='replace' && repGid){
	                                    // 执行替换
	                                    angular.forEach(m.data, function(r,index3) {
	                                        if(r.id==repGid){
	                                            var Gid = 'G'+new Date().getTime();
	                                            r.id = Gid;
	                                            r.img = s.img;
	                                            r.goodid = s.goodid;
	                                            r.name = s.name;
	                                            r.priceold = s.priceold;
	                                            r.pricenow = s.pricenow;
	                                            r.sales = s.sales;
	                                            r.unit = s.unit;
	                                            $('#floating-good .close').click();
	                                        }
	                                    });
	                                }
	                                else if(!repaction){
	                                    var Gid = 'G'+new Date().getTime();
	                                    // 执行添加
	                                    m.data.push({id:Gid,img:s.img,goodid:s.goodid,name:s.name,priceold:s.priceold,pricenow:s.pricenow});
	                                }
	                            }
	                        });
	                    }
	                });
	            }
	            $scope.selectGoods = [];
	            $scope.load = function(){}
	            $scope.changeImg = function(Mid,n){
	                width = parseInt($(".fe-mod-move").width());
	                height = (width* parseInt( n.replace("%","") ) /100)-16;
	                $("div[mid="+Mid+"] .fe-mod-8-main-img img").height(height);
	            };
	            $scope.setimg = function(Mid,n){
	                width = $(".fe-mod-move").width();
	                n = n.replace("%","");
	                n = n/100;
	                $("div[mid="+Mid+"] .fe-mod-12 img").height(width*n-30);
	            }
	            $scope.setfocus = function(Mid,e){
	                $scope.focus = Mid;
	                ccc = $("div[id="+Mid+"]").offset().top; 
	                ddd = (ccc-280)>=0?(ccc-280):0;
	                $(".fe-panel-editor").css("margin-top",ddd+"px");
	                $(document.body).animate({scrollTop:ccc-100},500);
	            }
	            $scope.drag = function(Mid){
	                var container = $("#editor");                
	                var del = container.find(".fe-mod-move");
	                del.off("mousedown").mousedown(function(e) {
	                    $scope.focus = Mid;
	                    if(e.which != 1 || $(e.target).is("textarea") || window.kp_only) return;
	                    e.preventDefault(); 
	                    var x = e.pageX;
	                    var y = e.pageY;
	                    var _this = $(this).parent(); 
	                    var w = _this.width();
	                    var h = _this.height();
	                    var w2 = w/2;
	                    var h2 = h/2;
	                    var p = _this.position();
	                    var left = p.left;
	                    var top = p.top;
	                    window.kp_only = true;
	                    _this.before('<div id="kp_widget_holder"></div>');
	                    var wid = $("#kp_widget_holder");
	                    var nod = $(".fe-mod-nodrag");
	                    wid.css({"border":"2px dashed #ccc", "height":_this.outerHeight(true)});
	                    _this.css({"width":w, "height":h, "position":"absolute", opacity: 0.8, "z-index": 900, "left":left, "top":top});
	                    $(document).mousemove(function(e) {
	                        $scope.focus = Mid;
	                        e.preventDefault();
	                        var l = left + e.pageX - x;
	                        var t = top + e.pageY - y;
	                        _this.css({"left":l, "top":t});
	                        var ml = l+w2;
	                        var mt = t+h2;
	                        del.parent().not(_this).not(wid).each(function(i) {
	                            var obj = $(this);
	                            var p = obj.position();
	                            var a1 = p.left;
	                            var a2 = p.left + obj.width();
	                            var a3 = p.top;
	                            var a4 = p.top + obj.height();
	                            if(a1 < ml && ml < a2 && a3 < mt && mt < a4) {
	                                if(!obj.next("#kp_widget_holder").length) {
	                                    wid.insertAfter(this);
	                                }else{
	                                    wid.insertBefore(this);
	                                }
	                                return;
	                            }
	                        });
	                    });
	                    $(document).mouseup(function() {
	                        $(document).off('mouseup').off('mousemove');
	                        $(container).each(function() {
	                            var obj = $(this).children();
	                            var len = obj.length;
	                            if(len == 1 && obj.is(_this)) {
	                                $("<div></div>").appendTo(this).attr("class", "kp_widget_block").css({"height":100});
	                            }
	                            else if(len == 2 && obj.is(".kp_widget_block")){
	                                $(this).children(".kp_widget_block").remove();
	                            }
	                        });
	                        var p = wid.position();
	                        _this.animate({"left":p.left, "top":p.top}, 100, function() {
	                            _this.removeAttr("style");
	                            wid.replaceWith(_this);
	                            window.kp_only = null;
	                            var arr = [];
	                            $(".fe-mod-repeat").find(".fe-mod-parent").each(function(i,val) {
	                                arr[i] = val.id;
	                            });
	                            var newarr = [];
	                            angular.forEach(arr, function(aid){
	                                angular.forEach($scope.Items, function(obj){
	                                    if(obj.id== aid){
	                                        newarr.push(obj);
	                                        return false;
	                                    }
	                                });
	                            });	
	                            $scope.Items = newarr;
	                        });
	                    });
	                });
	            }
	            $scope.addItem = function(Nid){
	                var Mid = 'M'+new Date().getTime();
	                var Navs = $scope.navs;
	                angular.forEach(Navs, function(n,index) {
	                    if(n.id==Nid){
	                        newparams = !clone(n.params)?'':clone(n.params);
	                        newdata = !n.data?'':cloneArr(n.data);
	                        newother = !clone(n.other)?'':clone(n.other);
	                        newcontent = !clone(n.content)?'':clone(n.content);
	                        if(Nid=='cube'){
	                            for (row = 0; row < 4; row++) { 
	                                for (newparams.layout[row] = {}, col = 0; col < 4; col++) {
	                                    newparams.layout[row][col] = {cols: 1,rows: 1,isempty: !0,imgurl: "",classname: ""};
	                                }
	                            }
	                        }
	                        var newitem = {id:Mid,temp:Nid,params:newparams,data:newdata,other:newother,content:newcontent};
	                        var insertindex = -1;
	                        if($scope.focus!=''){
	                              var Items = $scope.Items;
	                                angular.forEach(Items, function(a,index) {
	                                    if(a.id==$scope.focus){
	                                        insertindex = index;
	                                    }
	                              });
	                        }
	                        if(insertindex==-1){
	                            $scope.Items.push(newitem);
	                        }
	                        else{
	                           $scope.Items.splice(insertindex+1, 0, newitem);             
	                        }
	                        //$("div[id="+newitem.id+"]").trigger('ng-click');
	                        setTimeout(function(){
	                    		$scope.setfocus(newitem.id,null);     
	                        },100);
	                       
	                        //console.log($scope.Items);
	                    }
	                });
	            }
	            $scope.delItem = function(id){
	                if(confirm("此操作不可逆，确认移除？")){
	                    var Items = $scope.Items;
	                    angular.forEach(Items, function(a,index) {
	                        if(a.id==id){
	                            Items.splice(index,1);
	                            $scope.focus = '';
	                        }
	                    });
	                }
	            }
	            $scope.over = function(id){$("div[id="+id+"]").parent().find(".fe-mod-del").stop().show();}
	            $scope.out = function(id){$("div[id="+id+"]").parent().find(".fe-mod-del").stop().hide();}
	            $scope.save = function(n){
	                var pageid = "{$pageid}";
	                var items = cloneArr($scope.Items );
	                var del = "{$datas['default']}";
	                angular.forEach(items, function(m,index1) {
	                    if(m.temp=='richtext'){
	                        m.content = escape(m.content);
	                    }
	                });
	                var datas = angular.toJson(items);
	                var pageinfo = angular.toJson($scope.pages);
	                var pagename = $("input[name=pagename]").val();
	                var pagetype = $("input[name=pagetype]").val();
	                if(!pagename){
	                   alert('请给你的页面起一个响亮的名字吧');
	                   return;
	                }
	                if(!pagetype){
	                   alert('你还没有选择页面的类型哦~');
	                   return;
	                }
	                if(window.dosave=='1'){
	                   alert('触发关键字已存在！请重新填写。');
	                   $scope.focus = 'M0000000000000';
	                   return;
	                }
	                $(".fe-save-submit").text('保存中...').addClass("fe-save-disabled").data('saving','1');
	                if($(".fe-save-submit").data('saving')==1){
	               		if(n==3){
                            var grade = 0; 
                       } else {
                            var grade = 1; 
                       }
                       if(n==4){
                            var pageid = null;
                       }
                       if(del==0){
                       		var pageid = null;
                       }
	                    $.ajax({
	                        type: 'POST',
	                        url: "{php echo $this->createPluginWebUrl('designer',array('op'=>'api','apido'=>'savepage'))}",
	                        data: {del:del,pageid:pageid,grade:grade,datas:datas,pagetype:pagetype,pagename:pagename,pageinfo:pageinfo},
	                        success: function(data){
	                            if(n==1){
	                            	alert("保存成功！");
                                    location.href = "{php echo $this->createPluginWebUrl('designer')}";
	                            }else if(n==2){	                                	
	                                alert("保存成功！正在生成览页面...");
	                                setcookie(data);
	                                if(!pageid){
	                                    location.href = "{php echo $this->createPluginWebUrl('designer',array('op'=>'post'))}&pageid="+data;
	                                }else{
	                                    preview(data);
	                                }
	                            }else{
	                            	alert("保存成功！");
            		                location.href = "{php echo $this->createPluginWebUrl('designer/all_template')}";
	                            }  
	                            $(".fe-save-submit").text('保存').removeClass("fe-save-disabled").data('saving','0');
	                        },
	                        error: function(){
	                            alert('保存失败请重试');
	                            $(".fe-save-submit").text('保存').removeClass("fe-save-disabled").data('saving','0');
	                        }
	                    });
	                }
	            }
	            $scope.addGood = function(action,Mid,Gid){
	                $('#floating-good').modal();
	                $('#floating-good').attr({'action':action,'Gid':Gid});
	            }
	            $scope.delGood = function(Mid,Gid){
	                if(confirm("此操作不可逆，确认移除？")){
	                    var Items = $scope.Items;
	                    angular.forEach(Items, function(m,index1) {
	                        if(m.id==Mid){
	                            angular.forEach(m.data, function(g,index2) {
	                                if(g.id==Gid){
	                                    m.data.splice(index2,1);
	                                }
	                            });
	                        }
	                    });
	                }
	            }
	            $scope.shopImg = function(Mid){
	                require(['jquery', 'util'], function($, util){
	                    util.image('',function(data){
	                       var Items = $scope.Items;
	                       angular.forEach(Items, function(m,index1) {
	                           if(m.id==Mid){
	                               m.params.bgimg = data['url'];
	                               $("div[mid="+Mid+"]").mouseover();
	                           }
	                       });
	                    });
	                });
	            }
	            $scope.pageImg = function(Mid,type){
	                require(['jquery', 'util'], function($, util){
	                    util.image('',function(data){
	                        if(type=='floatimg'){
	                            $scope.pages[0].params.floatimg = data['url'];
	                        }else{
	                            $scope.pages[0].params.img = data['url'];
	                        }
	                       $("div[mid="+Mid+"]").trigger("click");
	                    });
	                });
	            }
	            $scope.$on('ngRepeatFinished',function(ngRepeatFinishedEvent){
	                $('.fe-mod-2 .swipe').each(function(){
	                        initswipe($(this));
	                 })
	                 $('.fe-mod-8-main-img img').each(function(){
	                     $(this).height($(this).width());    
	                 });
	                 $('.fe-mod-12 img').each(function(){
	                     $(this).height($(this).width());    
	                 });
	            });
	    }]);
	    myModel.directive('stringHtml' , function(){
	        return function(scope , el , attr){
	            if(attr.stringHtml){
	                scope.$watch(attr.stringHtml , function(html){ 
	                    el.html(html || '');
	                });
	            }
	        };
	    });  
	    myModel.directive("onFinishRenderFilters",function($timeout){
	        return{
	            restrict: 'A',
	            link: function(scope,element,attr){
	                if(scope.$last === true){
	                    $timeout(function(){
	                        scope.$emit('ngRepeatFinished');
	                    });
	                }
	            }
	        };
	    });
	</script>
	{/if}
	</div>
</div>
{template 'web/_footer'}